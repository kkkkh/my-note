# MongoDB
## 实践
### 事务
从 MongoDB 4.0（2018）开始，官方终于支持了 多文档事务（multi-document transactions）。
但设计理念不同：它更鼓励你通过“文档结构设计”避免频繁用事务。
| 特性                      | 说明                              |
| ----------------------- | ------------------------------- |
| **单文档操作始终原子化**          | 这一点从 1.0 起就保证                   |
| **多文档事务有，但不鼓励频繁使用**     | 因为性能代价较高                        |
| **推荐模型设计“文档内嵌”来减少事务需求** | MongoDB 鼓励通过数据结构设计保证一致性，而不是事务逻辑 |

MongoDB 的解决方案是：
- 通过数据建模、异步补偿、幂等逻辑 等手段，实现“逻辑上的一致性”，而不是数据库级强一致性。
- 场景 1：用户转账（必须两边一致）
  - 方案 A：事件表 + 状态驱动
  - 方案 B：使用单文档嵌套结构
- 场景 2：下单后扣库存、生成订单
  - 在 MongoDB 中常用 两阶段更新（two-phase update） 或 事件溯源（event sourcing）：
  - 通过状态机+异步队列（如 Kafka、RabbitMQ）保证一致性。


| 行业   | 事务使用情况      | 示例                                     |
| ---- | ----------- | -------------------------------------- |
| 电商   | ❌ 基本不用数据库事务 | 下单扣库存走消息队列、最终一致                        |
| 游戏   | ❌ 不用        | 通过 Redis + Mongo + 日志补偿                |
| 金融   | ✅ 使用事务      | 金融核心系统一般不用 MongoDB，而用 PostgreSQL/MySQL |
| 数据分析 | ❌ 不用        | 主要读多写少，无事务需求                           |
